# Cursor AI Rules for TimTracker2

## Project Context

This is a Next.js 14 application using the App Router pattern with Clerk authentication, Neon (PostgreSQL) database, TypeScript, and deployed on Vercel.

## Code Style & Conventions

- Use TypeScript with strict mode enabled
- Follow Next.js App Router patterns and conventions
- Use functional components with TypeScript
- Prefer server components when possible
- Use client components only when needed (interactivity, hooks, browser APIs)

## File Structure Conventions

- Pages: `app/[route]/page.tsx`
- API Routes: `app/api/[route]/route.ts`
- Layouts: `app/[route]/layout.tsx`
- Components: Co-locate with pages or create `components/` directory
- Types: Co-locate with usage or create `types/` directory
- Utilities: `lib/[utility].ts` (e.g., `lib/db.ts` for database connections)

## Authentication Patterns

- **Route Protection**: Always check `middleware.ts` before adding new routes
- **Public Routes**: Add to `isPublicRoute` matcher in `middleware.ts`
- **Auth Components**: Use Clerk's `<SignedIn>`, `<SignedOut>`, `<UserButton>`
- **Auth State**: Use `useAuth()` hook from `@clerk/nextjs` in client components
- **Server Auth**: Use `auth()` from `@clerk/nextjs/server` in server components/API routes

## API Route Guidelines

- Always verify authentication in API routes, even if behind middleware
- Use `NextResponse.json()` for JSON responses
- Handle errors appropriately with proper status codes
- Document request/response types with TypeScript interfaces

## Component Guidelines

- Prefer server components by default
- Mark client components with `'use client'` directive
- Use TypeScript interfaces for props
- Keep components focused and single-purpose

## Documentation Requirements

- Add JSDoc comments for complex functions
- Document non-obvious logic with inline comments
- Update `docs/ARCHITECTURE.md` for architectural changes
- Create PRD in `docs/PRDs/` for new features

## Error Handling

- Use try-catch blocks in async functions
- Return appropriate HTTP status codes in API routes
- Provide user-friendly error messages
- Log errors appropriately (consider adding logging service)

## Testing Considerations

- Write tests for complex business logic
- Test API routes with proper auth context
- Test middleware route protection
- Consider adding E2E tests for critical flows

## Performance

- Use Next.js Image component for images
- Implement proper loading states
- Consider using React Suspense for async components
- Optimize bundle size (check imports)

## When Adding Features

1. **Check existing patterns**: Look at similar features in the codebase
2. **Update middleware**: If adding routes, update `middleware.ts` if needed
3. **Create PRD**: Document the feature in `docs/PRDs/`
4. **Update docs**: Update `ARCHITECTURE.md` if architecture changes
5. **Follow conventions**: Use established patterns and file structure

## Common Patterns

### Protected Page
```typescript
// app/dashboard/page.tsx
import { auth } from '@clerk/nextjs/server';

export default async function DashboardPage() {
  const { userId } = await auth();
  // userId is guaranteed to exist due to middleware
  return <div>Dashboard for {userId}</div>;
}
```

### Protected API Route
```typescript
// app/api/data/route.ts
import { auth } from '@clerk/nextjs/server';
import { NextResponse } from 'next/server';

export async function GET() {
  const { userId } = await auth();
  if (!userId) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
  }
  // Handle request
  return NextResponse.json({ data: '...' });
}
```

### Client Component with Auth
```typescript
'use client';
import { useAuth } from '@clerk/nextjs';

export function ClientComponent() {
  const { userId, isLoaded } = useAuth();
  if (!isLoaded) return <div>Loading...</div>;
  return <div>User: {userId}</div>;
}
```

### Database Query Pattern
```typescript
// app/api/data/route.ts
import { auth } from '@clerk/nextjs/server';
import { NextResponse } from 'next/server';
import { getPool } from '@/lib/db';

export async function GET() {
  const { userId } = await auth();
  if (!userId) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
  }
  
  const pool = getPool();
  const result = await pool.query('SELECT * FROM table_name LIMIT 10');
  return NextResponse.json({ data: result.rows });
}
```

## Dependencies

- **Next.js 14**: Core framework
- **Clerk**: Authentication
- **pg**: PostgreSQL client for Neon database
- **TypeScript**: Type safety
- **React 18**: UI library

## Environment Variables

- Always check `README.md` for required env vars
- Never hardcode secrets
- Use `NEXT_PUBLIC_` prefix only for client-accessible variables
- Required variables:
  - `NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY` - Clerk public key (client-accessible)
  - `CLERK_SECRET_KEY` - Clerk secret key (server-only)
  - `NEON_DATABASE_URL` - Neon PostgreSQL connection string (server-only)

## Git Workflow

- Create feature branches for new work
- Write descriptive commit messages
- Create PRDs before major features
- Update documentation as you code

